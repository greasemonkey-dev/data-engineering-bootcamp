<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Comprehensive data engineering course for software engineers transitioning to data roles"><meta name=author content="Data Engineering Bootcamp Team"><link href=https://yourusername.github.io/data-engineering-course/chapters/01-python-sql-foundations/ rel=canonical><link href=../../course-description/ rel=prev><link href=quiz/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Content - Data Engineering Bootcamp</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#chapter-1-python-sql-foundations class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Data Engineering Bootcamp" class="md-header__button md-logo" aria-label="Data Engineering Bootcamp" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Data Engineering Bootcamp </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Content </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/yourusername/data-engineering-course title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> data-engineering-course </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../course-description/ class=md-tabs__link> Course Description </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=./ class=md-tabs__link> Chapters </a> </li> <li class=md-tabs__item> <a href=../../sims/sql-execution-plan/spec/ class=md-tabs__link> Interactive MicroSims </a> </li> <li class=md-tabs__item> <a href=../../glossary/ class=md-tabs__link> Resources </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Data Engineering Bootcamp" class="md-nav__button md-logo" aria-label="Data Engineering Bootcamp" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Data Engineering Bootcamp </label> <div class=md-nav__source> <a href=https://github.com/yourusername/data-engineering-course title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> data-engineering-course </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../course-description/ class=md-nav__link> <span class=md-ellipsis> Course Description </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Chapters </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Chapters </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1 checked> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex> <span class=md-ellipsis> Chapter 1 - Python & SQL Foundations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=true> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Chapter 1 - Python & SQL Foundations </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Content </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Content </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#learning-objectives class=md-nav__link> <span class=md-ellipsis> Learning Objectives </span> </a> </li> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#section-1-python-generators-processing-data-without-breaking-the-bank class=md-nav__link> <span class=md-ellipsis> Section 1: Python Generators - Processing Data Without Breaking the Bank </span> </a> <nav class=md-nav aria-label="Section 1: Python Generators - Processing Data Without Breaking the Bank"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-day-i-took-down-production-with-a-parenthesis class=md-nav__link> <span class=md-ellipsis> The Day I Took Down Production With a Parenthesis </span> </a> </li> <li class=md-nav__item> <a href=#heres-what-i-wish-id-known-generators-are-your-safety-net class=md-nav__link> <span class=md-ellipsis> Here's What I Wish I'd Known: Generators Are Your Safety Net </span> </a> </li> <li class=md-nav__item> <a href=#example-processing-a-large-csv-file class=md-nav__link> <span class=md-ellipsis> Example: Processing a Large CSV File </span> </a> </li> <li class=md-nav__item> <a href=#why-this-matters class=md-nav__link> <span class=md-ellipsis> Why This Matters </span> </a> </li> <li class=md-nav__item> <a href=#try-it class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#section-2-list-comprehensions-and-generator-expressions class=md-nav__link> <span class=md-ellipsis> Section 2: List Comprehensions and Generator Expressions </span> </a> <nav class=md-nav aria-label="Section 2: List Comprehensions and Generator Expressions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-pipeline-that-looked-perfect-until-it-wasnt class=md-nav__link> <span class=md-ellipsis> The Pipeline That Looked Perfect (Until It Wasn't) </span> </a> </li> <li class=md-nav__item> <a href=#heres-what-i-learned-choose-your-brackets-wisely class=md-nav__link> <span class=md-ellipsis> Here's What I Learned: Choose Your Brackets Wisely </span> </a> </li> <li class=md-nav__item> <a href=#example-data-transformation-pipeline class=md-nav__link> <span class=md-ellipsis> Example: Data Transformation Pipeline </span> </a> </li> <li class=md-nav__item> <a href=#when-to-use-each class=md-nav__link> <span class=md-ellipsis> When to Use Each </span> </a> </li> <li class=md-nav__item> <a href=#try-it_1 class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#section-3-sql-window-functions-analytics-without-self-joins class=md-nav__link> <span class=md-ellipsis> Section 3: SQL Window Functions - Analytics Without Self-Joins </span> </a> <nav class=md-nav aria-label="Section 3: SQL Window Functions - Analytics Without Self-Joins"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-query-that-took-three-days-and-shouldve-taken-three-minutes class=md-nav__link> <span class=md-ellipsis> The Query That Took Three Days (And Should've Taken Three Minutes) </span> </a> </li> <li class=md-nav__item> <a href=#heres-what-window-functions-actually-do class=md-nav__link> <span class=md-ellipsis> Here's What Window Functions Actually Do </span> </a> </li> <li class=md-nav__item> <a href=#example-e-commerce-analytics-dashboard class=md-nav__link> <span class=md-ellipsis> Example: E-Commerce Analytics Dashboard </span> </a> </li> <li class=md-nav__item> <a href=#understanding-the-over-clause class=md-nav__link> <span class=md-ellipsis> Understanding the OVER Clause </span> </a> </li> <li class=md-nav__item> <a href=#common-window-functions class=md-nav__link> <span class=md-ellipsis> Common Window Functions </span> </a> </li> <li class=md-nav__item> <a href=#why-this-matters_1 class=md-nav__link> <span class=md-ellipsis> Why This Matters </span> </a> </li> <li class=md-nav__item> <a href=#try-it_2 class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#section-4-common-table-expressions-ctes-writing-readable-sql class=md-nav__link> <span class=md-ellipsis> Section 4: Common Table Expressions (CTEs) - Writing Readable SQL </span> </a> <nav class=md-nav aria-label="Section 4: Common Table Expressions (CTEs) - Writing Readable SQL"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-query-my-future-self-couldnt-understand class=md-nav__link> <span class=md-ellipsis> The Query My Future Self Couldn't Understand </span> </a> </li> <li class=md-nav__item> <a href=#heres-why-ctes-are-your-friend class=md-nav__link> <span class=md-ellipsis> Here's Why CTEs Are Your Friend </span> </a> </li> <li class=md-nav__item> <a href=#example-multi-step-business-logic class=md-nav__link> <span class=md-ellipsis> Example: Multi-Step Business Logic </span> </a> </li> <li class=md-nav__item> <a href=#recursive-ctes-handling-hierarchical-data class=md-nav__link> <span class=md-ellipsis> Recursive CTEs: Handling Hierarchical Data </span> </a> </li> <li class=md-nav__item> <a href=#why-this-matters_2 class=md-nav__link> <span class=md-ellipsis> Why This Matters </span> </a> </li> <li class=md-nav__item> <a href=#try-it_3 class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scars-ive-earned-so-you-dont-have-to class=md-nav__link> <span class=md-ellipsis> Scars I've Earned (So You Don't Have To) </span> </a> <nav class=md-nav aria-label="Scars I've Earned (So You Don't Have To)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-using-list-comprehensions-when-you-need-generators class=md-nav__link> <span class=md-ellipsis> 1. Using List Comprehensions When You Need Generators </span> </a> </li> <li class=md-nav__item> <a href=#2-forgetting-partition-by-in-window-functions class=md-nav__link> <span class=md-ellipsis> 2. Forgetting PARTITION BY in Window Functions </span> </a> </li> <li class=md-nav__item> <a href=#3-over-nesting-ctes class=md-nav__link> <span class=md-ellipsis> 3. Over-Nesting CTEs </span> </a> </li> <li class=md-nav__item> <a href=#4-not-understanding-generator-exhaustion class=md-nav__link> <span class=md-ellipsis> 4. Not Understanding Generator Exhaustion </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reflection-questions class=md-nav__link> <span class=md-ellipsis> Reflection Questions </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> <span class=md-ellipsis> Next Steps </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=quiz/ class=md-nav__link> <span class=md-ellipsis> Quiz </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex> <span class=md-ellipsis> Chapter 2 - Git & Docker </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Chapter 2 - Git & Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../02-git-docker/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> <li class=md-nav__item> <a href=../02-git-docker/quiz/ class=md-nav__link> <span class=md-ellipsis> Quiz </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex> <span class=md-ellipsis> Chapter 3 - Database Modeling </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Chapter 3 - Database Modeling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../03-database-modeling/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> <li class=md-nav__item> <a href=../03-database-modeling/quiz/ class=md-nav__link> <span class=md-ellipsis> Quiz </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> Chapter 4 - Data Warehousing </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Chapter 4 - Data Warehousing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../04-data-warehousing/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> <li class=md-nav__item> <a href=../04-data-warehousing/quiz/ class=md-nav__link> <span class=md-ellipsis> Quiz </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> Chapter 5 - ETL/ELT & Apache Airflow </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Chapter 5 - ETL/ELT & Apache Airflow </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../05-etl-airflow/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> <li class=md-nav__item> <a href=../05-etl-airflow/quiz/ class=md-nav__link> <span class=md-ellipsis> Quiz </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6 id=__nav_3_6_label tabindex> <span class=md-ellipsis> Chapter 6 - Data Quality & Error Handling </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Chapter 6 - Data Quality & Error Handling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../06-data-quality/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_7> <label class=md-nav__link for=__nav_3_7 id=__nav_3_7_label tabindex> <span class=md-ellipsis> Chapter 7 - Apache Spark & PySpark </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_7_label aria-expanded=false> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> Chapter 7 - Apache Spark & PySpark </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../07-spark-pyspark/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_8> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex> <span class=md-ellipsis> Chapter 8 - Kafka & Streaming Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=false> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> Chapter 8 - Kafka & Streaming Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../08-kafka-streaming/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_9> <label class=md-nav__link for=__nav_3_9 id=__nav_3_9_label tabindex> <span class=md-ellipsis> Chapter 9 - Cloud Data Engineering (GCP) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_9_label aria-expanded=false> <label class=md-nav__title for=__nav_3_9> <span class="md-nav__icon md-icon"></span> Chapter 9 - Cloud Data Engineering (GCP) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../09-cloud-gcp/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_10> <label class=md-nav__link for=__nav_3_10 id=__nav_3_10_label tabindex> <span class=md-ellipsis> Chapter 10 - Infrastructure as Code & CI/CD </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_10_label aria-expanded=false> <label class=md-nav__title for=__nav_3_10> <span class="md-nav__icon md-icon"></span> Chapter 10 - Infrastructure as Code & CI/CD </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../10-iac-cicd/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_11> <label class=md-nav__link for=__nav_3_11 id=__nav_3_11_label tabindex> <span class=md-ellipsis> Chapter 11 - Capstone Project (Design) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_11_label aria-expanded=false> <label class=md-nav__title for=__nav_3_11> <span class="md-nav__icon md-icon"></span> Chapter 11 - Capstone Project (Design) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../11-capstone-part1/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_12> <label class=md-nav__link for=__nav_3_12 id=__nav_3_12_label tabindex> <span class=md-ellipsis> Chapter 12 - Capstone Project (Implementation) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_12_label aria-expanded=false> <label class=md-nav__title for=__nav_3_12> <span class="md-nav__icon md-icon"></span> Chapter 12 - Capstone Project (Implementation) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../12-capstone-part2/ class=md-nav__link> <span class=md-ellipsis> Content </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Interactive MicroSims </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Interactive MicroSims </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../sims/sql-execution-plan/spec/ class=md-nav__link> <span class=md-ellipsis> SQL Execution Plan Visualizer </span> </a> </li> <li class=md-nav__item> <a href=../../sims/git-merge-rebase/spec/ class=md-nav__link> <span class=md-ellipsis> Git Merge vs Rebase </span> </a> </li> <li class=md-nav__item> <a href=../../sims/star-vs-snowflake/spec/ class=md-nav__link> <span class=md-ellipsis> Star vs Snowflake Schema </span> </a> </li> <li class=md-nav__item> <a href=../../sims/normalization-journey/spec/ class=md-nav__link> <span class=md-ellipsis> Database Normalization </span> </a> </li> <li class=md-nav__item> <a href=../../sims/bigquery-partitioning/spec/ class=md-nav__link> <span class=md-ellipsis> BigQuery Partitioning </span> </a> </li> <li class=md-nav__item> <a href=../../sims/scd-timeline/spec/ class=md-nav__link> <span class=md-ellipsis> Slowly Changing Dimensions </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../glossary/ class=md-nav__link> <span class=md-ellipsis> Glossary </span> </a> </li> <li class=md-nav__item> <a href=../../faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class=md-nav__item> <a href=../../learning-graph/learning-graph.json class=md-nav__link> <span class=md-ellipsis> Learning Graph </span> </a> </li> <li class=md-nav__item> <a href=../INDEX/ class=md-nav__link> <span class=md-ellipsis> Quiz Guide </span> </a> </li> <li class=md-nav__item> <a href=../INSTRUCTOR_GUIDE/ class=md-nav__link> <span class=md-ellipsis> Instructor Guide </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#learning-objectives class=md-nav__link> <span class=md-ellipsis> Learning Objectives </span> </a> </li> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#section-1-python-generators-processing-data-without-breaking-the-bank class=md-nav__link> <span class=md-ellipsis> Section 1: Python Generators - Processing Data Without Breaking the Bank </span> </a> <nav class=md-nav aria-label="Section 1: Python Generators - Processing Data Without Breaking the Bank"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-day-i-took-down-production-with-a-parenthesis class=md-nav__link> <span class=md-ellipsis> The Day I Took Down Production With a Parenthesis </span> </a> </li> <li class=md-nav__item> <a href=#heres-what-i-wish-id-known-generators-are-your-safety-net class=md-nav__link> <span class=md-ellipsis> Here's What I Wish I'd Known: Generators Are Your Safety Net </span> </a> </li> <li class=md-nav__item> <a href=#example-processing-a-large-csv-file class=md-nav__link> <span class=md-ellipsis> Example: Processing a Large CSV File </span> </a> </li> <li class=md-nav__item> <a href=#why-this-matters class=md-nav__link> <span class=md-ellipsis> Why This Matters </span> </a> </li> <li class=md-nav__item> <a href=#try-it class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#section-2-list-comprehensions-and-generator-expressions class=md-nav__link> <span class=md-ellipsis> Section 2: List Comprehensions and Generator Expressions </span> </a> <nav class=md-nav aria-label="Section 2: List Comprehensions and Generator Expressions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-pipeline-that-looked-perfect-until-it-wasnt class=md-nav__link> <span class=md-ellipsis> The Pipeline That Looked Perfect (Until It Wasn't) </span> </a> </li> <li class=md-nav__item> <a href=#heres-what-i-learned-choose-your-brackets-wisely class=md-nav__link> <span class=md-ellipsis> Here's What I Learned: Choose Your Brackets Wisely </span> </a> </li> <li class=md-nav__item> <a href=#example-data-transformation-pipeline class=md-nav__link> <span class=md-ellipsis> Example: Data Transformation Pipeline </span> </a> </li> <li class=md-nav__item> <a href=#when-to-use-each class=md-nav__link> <span class=md-ellipsis> When to Use Each </span> </a> </li> <li class=md-nav__item> <a href=#try-it_1 class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#section-3-sql-window-functions-analytics-without-self-joins class=md-nav__link> <span class=md-ellipsis> Section 3: SQL Window Functions - Analytics Without Self-Joins </span> </a> <nav class=md-nav aria-label="Section 3: SQL Window Functions - Analytics Without Self-Joins"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-query-that-took-three-days-and-shouldve-taken-three-minutes class=md-nav__link> <span class=md-ellipsis> The Query That Took Three Days (And Should've Taken Three Minutes) </span> </a> </li> <li class=md-nav__item> <a href=#heres-what-window-functions-actually-do class=md-nav__link> <span class=md-ellipsis> Here's What Window Functions Actually Do </span> </a> </li> <li class=md-nav__item> <a href=#example-e-commerce-analytics-dashboard class=md-nav__link> <span class=md-ellipsis> Example: E-Commerce Analytics Dashboard </span> </a> </li> <li class=md-nav__item> <a href=#understanding-the-over-clause class=md-nav__link> <span class=md-ellipsis> Understanding the OVER Clause </span> </a> </li> <li class=md-nav__item> <a href=#common-window-functions class=md-nav__link> <span class=md-ellipsis> Common Window Functions </span> </a> </li> <li class=md-nav__item> <a href=#why-this-matters_1 class=md-nav__link> <span class=md-ellipsis> Why This Matters </span> </a> </li> <li class=md-nav__item> <a href=#try-it_2 class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#section-4-common-table-expressions-ctes-writing-readable-sql class=md-nav__link> <span class=md-ellipsis> Section 4: Common Table Expressions (CTEs) - Writing Readable SQL </span> </a> <nav class=md-nav aria-label="Section 4: Common Table Expressions (CTEs) - Writing Readable SQL"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-query-my-future-self-couldnt-understand class=md-nav__link> <span class=md-ellipsis> The Query My Future Self Couldn't Understand </span> </a> </li> <li class=md-nav__item> <a href=#heres-why-ctes-are-your-friend class=md-nav__link> <span class=md-ellipsis> Here's Why CTEs Are Your Friend </span> </a> </li> <li class=md-nav__item> <a href=#example-multi-step-business-logic class=md-nav__link> <span class=md-ellipsis> Example: Multi-Step Business Logic </span> </a> </li> <li class=md-nav__item> <a href=#recursive-ctes-handling-hierarchical-data class=md-nav__link> <span class=md-ellipsis> Recursive CTEs: Handling Hierarchical Data </span> </a> </li> <li class=md-nav__item> <a href=#why-this-matters_2 class=md-nav__link> <span class=md-ellipsis> Why This Matters </span> </a> </li> <li class=md-nav__item> <a href=#try-it_3 class=md-nav__link> <span class=md-ellipsis> Try It </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scars-ive-earned-so-you-dont-have-to class=md-nav__link> <span class=md-ellipsis> Scars I've Earned (So You Don't Have To) </span> </a> <nav class=md-nav aria-label="Scars I've Earned (So You Don't Have To)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-using-list-comprehensions-when-you-need-generators class=md-nav__link> <span class=md-ellipsis> 1. Using List Comprehensions When You Need Generators </span> </a> </li> <li class=md-nav__item> <a href=#2-forgetting-partition-by-in-window-functions class=md-nav__link> <span class=md-ellipsis> 2. Forgetting PARTITION BY in Window Functions </span> </a> </li> <li class=md-nav__item> <a href=#3-over-nesting-ctes class=md-nav__link> <span class=md-ellipsis> 3. Over-Nesting CTEs </span> </a> </li> <li class=md-nav__item> <a href=#4-not-understanding-generator-exhaustion class=md-nav__link> <span class=md-ellipsis> 4. Not Understanding Generator Exhaustion </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reflection-questions class=md-nav__link> <span class=md-ellipsis> Reflection Questions </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> <span class=md-ellipsis> Next Steps </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=chapter-1-python-sql-foundations>Chapter 1: Python &amp; SQL Foundations<a class=headerlink href=#chapter-1-python-sql-foundations title="Permanent link">&para;</a></h1> <h2 id=learning-objectives>Learning Objectives<a class=headerlink href=#learning-objectives title="Permanent link">&para;</a></h2> <p>By the end of this chapter, you will be able to: 1. <strong>Write</strong> efficient Python code using list comprehensions and generators to process large datasets with minimal memory overhead 2. <strong>Construct</strong> complex SQL queries using window functions and CTEs to perform advanced analytical operations 3. <strong>Analyze</strong> the performance characteristics of different Python data structures and choose appropriate ones for data engineering tasks 4. <strong>Evaluate</strong> query performance and apply optimization techniques to improve SQL execution time</p> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>It's 3 AM on a Thursday. Your phone buzzes. Then buzzes again. Then starts ringing.</p> <p>You grab it, squinting at the screen. Twelve missed messages. Three calls from your manager. Five alerts from your monitoring system. And one text from your coworker that just says: "Dude. What did you deploy???"</p> <p>Your data pipeline—the one you proudly deployed yesterday afternoon, right before heading home—is crawling to a halt. Processing 100 rows per minute instead of the expected 10,000. The dashboard is stale. Customers are complaining. And you're frantically SSHing into a server in your pajamas, watching memory usage spike to 99%, wondering where exactly your life went wrong.</p> <p>You find the problem. Line 47. One single, innocent-looking line:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=n>data</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>read_csv</span><span class=p>(</span><span class=s1>&#39;transactions.csv&#39;</span><span class=p>))</span>
</span></code></pre></div> <p>That's it. That's what brought everything down. You just tried to load 50 million rows into memory. All at once. The server never stood a chance.</p> <p>Welcome to data engineering.</p> <p>This chapter is about the difference between code that works and code that works <em>at scale</em>. You're not just writing scripts anymore—you're building pipelines that process millions of rows, run for hours, and need to recover gracefully when things go wrong (and they will go wrong).</p> <p>The difference between a junior engineer and a senior one? It often comes down to understanding a handful of fundamental concepts: when to use a generator instead of a list, how to write SQL that leverages indexes, and why your query that works beautifully on 1,000 rows brings the database to its knees at 1,000,000.</p> <p>Let's start with Python, then move to SQL. I'm going to tell you about some of my worst mistakes. Not because I enjoy embarrassing myself (though my therapist says it's healthy), but because I learned more from these disasters than from any tutorial.</p> <p>By the end of this chapter, you'll understand not just <em>what</em> these tools do, but <em>when</em> and <em>why</em> to use them. And maybe you'll avoid taking down production at 3 AM.</p> <h2 id=section-1-python-generators-processing-data-without-breaking-the-bank>Section 1: Python Generators - Processing Data Without Breaking the Bank<a class=headerlink href=#section-1-python-generators-processing-data-without-breaking-the-bank title="Permanent link">&para;</a></h2> <h3 id=the-day-i-took-down-production-with-a-parenthesis>The Day I Took Down Production With a Parenthesis<a class=headerlink href=#the-day-i-took-down-production-with-a-parenthesis title="Permanent link">&para;</a></h3> <p>So there I was, three months into my first data engineering job, feeling pretty good about myself. I'd just finished a script to process our daily transaction logs and email a summary to the finance team. Ran beautifully on my laptop with the test file. Deployed to production on a Thursday afternoon. (Yes, I was <em>that</em> engineer.)</p> <p>Sunday morning, 6:47 AM. My phone starts blowing up. Not texts. Calls. From people I didn't even know had my number.</p> <p>The server was dead. Not slow. Not struggling. Completely unresponsive. I SSH'd in and nearly fell out of my chair. Memory usage: 47GB out of 48GB. The machine was thrashing so hard the disk I/O looked like a heart monitor during a panic attack.</p> <p>I frantically scanned my beautiful, elegant code. There it was, line 23:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>transactions</span> <span class=o>=</span> <span class=p>[</span><span class=n>parse_line</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;daily_transactions.csv&#39;</span><span class=p>)]</span>
</span></code></pre></div> <p>That's it. That's the whole problem. A single pair of square brackets.</p> <p>See, my test file had 50,000 rows. The production file? 52 million. And I'd just told Python to load every single one into a list. In memory. All at once. The mental image that still haunts me: Python dutifully trying to build a list the size of a small country while the server slowly suffocated.</p> <p>My senior engineer showed me the fix. One character change:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=n>transactions</span> <span class=o>=</span> <span class=p>(</span><span class=n>parse_line</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;daily_transactions.csv&#39;</span><span class=p>))</span>
</span></code></pre></div> <p>Square brackets to parentheses. That's it. Memory usage dropped to 300MB. The script processed all 52 million rows without breaking a sweat.</p> <p>That $47,000 AWS bill (two days of emergency instances while we recovered) taught me more about Python generators than any tutorial ever could.</p> <h3 id=heres-what-i-wish-id-known-generators-are-your-safety-net>Here's What I Wish I'd Known: Generators Are Your Safety Net<a class=headerlink href=#heres-what-i-wish-id-known-generators-are-your-safety-net title="Permanent link">&para;</a></h3> <p>Generators allow you to process data one item at a time, rather than loading everything into memory at once. They're the difference between a pipeline that scales and one that crashes (and costs you $47,000).</p> <div style="text-align: center; margin: 2em 0;"> <video width=80% controls loop muted playsinline style="max-width: 800px; border: 1px solid #ddd; border-radius: 8px;"> <source src=../../videos/generators-vs-lists.mp4 type=video/mp4> <p>Your browser does not support the video tag. <a href=../../videos/generators-vs-lists.mp4>Download the video</a> instead.</p> </video> </div> <h3 id=example-processing-a-large-csv-file>Example: Processing a Large CSV File<a class=headerlink href=#example-processing-a-large-csv-file title="Permanent link">&para;</a></h3> <p>Imagine you're building a data pipeline that processes daily transaction logs. Each file contains millions of rows. Let's look at two approaches:</p> <p><strong>The Memory-Hungry Approach:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>def</span><span class=w> </span><span class=nf>process_transactions_bad</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=c1># Load ALL transactions into memory at once</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>transactions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>            <span class=n>transactions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>parse_transaction</span><span class=p>(</span><span class=n>line</span><span class=p>))</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    <span class=c1># Filter for high-value transactions</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>    <span class=n>high_value</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>transactions</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>]</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>    <span class=c1># Calculate total</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>    <span class=n>total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>high_value</span><span class=p>)</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>    <span class=k>return</span> <span class=n>total</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=c1># With 10 million rows, this might use 5+ GB of RAM</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=n>result</span> <span class=o>=</span> <span class=n>process_transactions_bad</span><span class=p>(</span><span class=s1>&#39;transactions.csv&#39;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>The Scalable Approach Using Generators:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>def</span><span class=w> </span><span class=nf>read_transactions</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Generator that yields one transaction at a time&quot;&quot;&quot;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>            <span class=k>yield</span> <span class=n>parse_transaction</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=k>def</span><span class=w> </span><span class=nf>process_transactions_good</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=c1># No data loaded yet - just created a generator object</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    <span class=n>transactions</span> <span class=o>=</span> <span class=n>read_transactions</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>    <span class=c1># Filter using a generator expression (not a list comprehension!)</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>    <span class=n>high_value</span> <span class=o>=</span> <span class=p>(</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>transactions</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>)</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>    <span class=c1># Calculate total - data is processed one row at a time</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>    <span class=n>total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>high_value</span><span class=p>)</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>    <span class=k>return</span> <span class=n>total</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=c1># Memory usage stays constant regardless of file size</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=n>result</span> <span class=o>=</span> <span class=n>process_transactions_good</span><span class=p>(</span><span class=s1>&#39;transactions.csv&#39;</span><span class=p>)</span>
</span></code></pre></div> <p>Notice the subtle difference: <code>(t for t in ...)</code> uses parentheses (generator expression), while <code>[t for t in ...]</code> uses brackets (list comprehension). This small syntax change has huge implications.</p> <p>Let's measure the difference:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>import</span><span class=w> </span><span class=nn>tracemalloc</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=c1># Test with the list approach</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=n>tracemalloc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=n>data_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span><span class=o>**</span><span class=mi>2</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10_000_000</span><span class=p>)]</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=n>list_memory</span> <span class=o>=</span> <span class=n>tracemalloc</span><span class=o>.</span><span class=n>get_traced_memory</span><span class=p>()[</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># Peak memory</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=n>tracemalloc</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=c1># Test with the generator approach</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=n>tracemalloc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=n>data_gen</span> <span class=o>=</span> <span class=p>(</span><span class=n>i</span><span class=o>**</span><span class=mi>2</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10_000_000</span><span class=p>))</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=c1># Process one at a time</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>data_gen</span><span class=p>:</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>    <span class=k>pass</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=n>gen_memory</span> <span class=o>=</span> <span class=n>tracemalloc</span><span class=o>.</span><span class=n>get_traced_memory</span><span class=p>()[</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># Peak memory</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=n>tracemalloc</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;List approach: </span><span class=si>{</span><span class=n>list_memory</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1024</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> MB&quot;</span><span class=p>)</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Generator approach: </span><span class=si>{</span><span class=n>gen_memory</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1024</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> MB&quot;</span><span class=p>)</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=c1># Output:</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=c1># List approach: 381.5 MB</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=c1># Generator approach: 0.1 MB</span>
</span></code></pre></div> <h3 id=why-this-matters>Why This Matters<a class=headerlink href=#why-this-matters title="Permanent link">&para;</a></h3> <p>In data engineering, you rarely work with data that fits comfortably in memory. Consider:</p> <ul> <li><strong>Log files</strong>: A single day of application logs can be 100+ GB</li> <li><strong>Database exports</strong>: Exporting a production table might yield billions of rows</li> <li><strong>Stream processing</strong>: Data arrives continuously; you can't "load it all" because there is no "all"</li> </ul> <p>Generators enable <strong>streaming data processing</strong>—the cornerstone of scalable data pipelines. They let you build systems that process terabytes of data on machines with gigabytes of RAM.</p> <h3 id=try-it>Try It<a class=headerlink href=#try-it title="Permanent link">&para;</a></h3> <p>Open a Python REPL and try this:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1># This will crash on most laptops</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=n>numbers</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1_000_000_000</span><span class=p>)]</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=c1># This works fine</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=n>numbers</span> <span class=o>=</span> <span class=p>(</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1_000_000_000</span><span class=p>))</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=n>first_ten</span> <span class=o>=</span> <span class=p>[</span><span class=nb>next</span><span class=p>(</span><span class=n>numbers</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>)]</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=nb>print</span><span class=p>(</span><span class=n>first_ten</span><span class=p>)</span>  <span class=c1># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
</span></code></pre></div> <p>Now imagine you're reading from a database instead of generating numbers. Can you sketch out how you'd write a generator function that yields rows from a SQL query one at a time?</p> <h2 id=section-2-list-comprehensions-and-generator-expressions>Section 2: List Comprehensions and Generator Expressions<a class=headerlink href=#section-2-list-comprehensions-and-generator-expressions title="Permanent link">&para;</a></h2> <h3 id=the-pipeline-that-looked-perfect-until-it-wasnt>The Pipeline That Looked Perfect (Until It Wasn't)<a class=headerlink href=#the-pipeline-that-looked-perfect-until-it-wasnt title="Permanent link">&para;</a></h3> <p>Let me tell you about the code review that still makes me cringe.</p> <p>I'd built this beautiful ETL pipeline to process customer records. Clean code. Nicely commented. Each transformation step on its own line. I was <em>proud</em> of this thing. Submitted the PR on Sunday morning, confident my tech lead would approve it by lunch.</p> <p>Instead, I got a single comment: "This will crash in production. Try it with the real dataset first."</p> <p>I was confused. Insulted, even. My code was elegant! Look at how readable these chained transformations were:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=n>lines</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=n>records</span> <span class=o>=</span> <span class=p>[</span><span class=n>parse_customer</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>]</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=n>normalized</span> <span class=o>=</span> <span class=p>[</span><span class=n>normalize_phone</span><span class=p>(</span><span class=n>r</span><span class=p>)</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>records</span><span class=p>]</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=n>valid</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>normalized</span> <span class=k>if</span> <span class=n>is_valid_email</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>])]</span>
</span></code></pre></div> <p>So I did what she asked. Downloaded the actual production customer database. 18 million records. Hit run.</p> <p>My laptop froze. Not "spinning beach ball" frozen. Full kernel panic frozen. Had to force restart. Lost my unsaved code. (Yes, I learned about git commits that day too.)</p> <p>Turns out, each of those innocent-looking list comprehensions was creating a complete copy of 18 million records in memory. Four complete copies. My poor laptop with its 16GB of RAM never stood a chance.</p> <p>My tech lead showed me the fix:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=n>lines</span> <span class=o>=</span> <span class=n>f</span>  <span class=c1># Don&#39;t even call readlines()</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=n>records</span> <span class=o>=</span> <span class=p>(</span><span class=n>parse_customer</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>)</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=n>normalized</span> <span class=o>=</span> <span class=p>({</span><span class=o>**</span><span class=n>r</span><span class=p>,</span> <span class=s1>&#39;phone&#39;</span><span class=p>:</span> <span class=n>normalize_phone</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>])}</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>records</span><span class=p>)</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=n>valid</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>normalized</span> <span class=k>if</span> <span class=n>is_valid_email</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]))</span>
</span></code></pre></div> <p>Same logic. Different brackets. Memory usage went from "kernel panic" to "barely noticeable."</p> <p>The kicker? She said "Now you understand why we don't let juniors merge to main without testing on real data." I didn't deploy to production that time. I crashed my own laptop in the safety of my bedroom.</p> <h3 id=heres-what-i-learned-choose-your-brackets-wisely>Here's What I Learned: Choose Your Brackets Wisely<a class=headerlink href=#heres-what-i-learned-choose-your-brackets-wisely title="Permanent link">&para;</a></h3> <p>List comprehensions and generator expressions provide concise, readable syntax for transforming and filtering data. Choose list comprehensions when you need to reuse the data; choose generator expressions when you're processing it once.</p> <h3 id=example-data-transformation-pipeline>Example: Data Transformation Pipeline<a class=headerlink href=#example-data-transformation-pipeline title="Permanent link">&para;</a></h3> <p>You're building an ETL pipeline that needs to: 1. Read customer records from a CSV 2. Parse and validate each record 3. Normalize phone numbers 4. Filter out invalid emails 5. Output to a database</p> <p><strong>Readable but Inefficient:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>def</span><span class=w> </span><span class=nf>process_customers_verbose</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>    <span class=c1># Step 1: Read all data</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>        <span class=n>lines</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>    <span class=c1># Step 2: Parse</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>    <span class=n>records</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>        <span class=n>records</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>parse_customer</span><span class=p>(</span><span class=n>line</span><span class=p>))</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>    <span class=c1># Step 3: Normalize phones</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>    <span class=n>normalized</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>    <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>records</span><span class=p>:</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>        <span class=n>record</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>normalize_phone</span><span class=p>(</span><span class=n>record</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>])</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>        <span class=n>normalized</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>record</span><span class=p>)</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>    <span class=c1># Step 4: Filter</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>    <span class=n>valid</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a>    <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>normalized</span><span class=p>:</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>        <span class=k>if</span> <span class=n>is_valid_email</span><span class=p>(</span><span class=n>record</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]):</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a>            <span class=n>valid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>record</span><span class=p>)</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a>    <span class=k>return</span> <span class=n>valid</span>
</span></code></pre></div> <p><strong>Pythonic and Efficient:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>def</span><span class=w> </span><span class=nf>process_customers_pythonic</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>        <span class=c1># Chained generator expressions - each step processes one item at a time</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>        <span class=n>records</span> <span class=o>=</span> <span class=p>(</span><span class=n>parse_customer</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>f</span><span class=p>)</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>        <span class=n>normalized</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>            <span class=p>{</span><span class=o>**</span><span class=n>record</span><span class=p>,</span> <span class=s1>&#39;phone&#39;</span><span class=p>:</span> <span class=n>normalize_phone</span><span class=p>(</span><span class=n>record</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>])}</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>            <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>records</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>        <span class=p>)</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>        <span class=n>valid</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>            <span class=n>record</span> <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>normalized</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>            <span class=k>if</span> <span class=n>is_valid_email</span><span class=p>(</span><span class=n>record</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>])</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>        <span class=p>)</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>        <span class=c1># Only when we iterate over &#39;valid&#39; does any processing happen</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>        <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>valid</span><span class=p>:</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>            <span class=n>insert_to_database</span><span class=p>(</span><span class=n>record</span><span class=p>)</span>
</span></code></pre></div> <p>Notice how the second version: - Uses <strong>less memory</strong> (no intermediate lists) - Is <strong>more readable</strong> (each transformation is one line) - Is <strong>more composable</strong> (easy to add/remove steps)</p> <h3 id=when-to-use-each>When to Use Each<a class=headerlink href=#when-to-use-each title="Permanent link">&para;</a></h3> <p><strong>Use list comprehensions when:</strong> - You need to iterate over the data multiple times - The dataset is small enough to fit in memory - You need to check the length or access by index</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># Good use of list comprehension</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=n>user_ids</span> <span class=o>=</span> <span class=p>[</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>users</span><span class=p>]</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Processing </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>user_ids</span><span class=p>)</span><span class=si>}</span><span class=s2> users&quot;</span><span class=p>)</span>  <span class=c1># Need length</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=k>for</span> <span class=n>user_id</span> <span class=ow>in</span> <span class=n>user_ids</span><span class=p>:</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>    <span class=n>process</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=k>for</span> <span class=n>user_id</span> <span class=ow>in</span> <span class=n>user_ids</span><span class=p>:</span>  <span class=c1># Iterate again</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>    <span class=n>cleanup</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Use generator expressions when:</strong> - You process each item exactly once - The dataset is large - You're feeding the data into another function (like <code>sum()</code>, <code>max()</code>, or database insert)</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># Good use of generator expression</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=n>total_revenue</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=n>order</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>    <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=n>read_orders</span><span class=p>(</span><span class=s1>&#39;orders.csv&#39;</span><span class=p>)</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>    <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;completed&#39;</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=p>)</span>
</span></code></pre></div> <h3 id=try-it_1>Try It<a class=headerlink href=#try-it_1 title="Permanent link">&para;</a></h3> <p>Let's say you have a list of URLs and you want to extract the domain names. Try writing both versions:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=n>urls</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>    <span class=s1>&#39;https://example.com/page1&#39;</span><span class=p>,</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>    <span class=s1>&#39;https://test.org/page2&#39;</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>    <span class=s1>&#39;https://example.com/page3&#39;</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=p>]</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=c1># Using list comprehension</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=n>domains_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>url</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)[</span><span class=mi>2</span><span class=p>]</span> <span class=k>for</span> <span class=n>url</span> <span class=ow>in</span> <span class=n>urls</span><span class=p>]</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=c1># Using generator expression</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=n>domains_gen</span> <span class=o>=</span> <span class=p>(</span><span class=n>url</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)[</span><span class=mi>2</span><span class=p>]</span> <span class=k>for</span> <span class=n>url</span> <span class=ow>in</span> <span class=n>urls</span><span class=p>)</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=c1># What happens if you print them?</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=nb>print</span><span class=p>(</span><span class=n>domains_list</span><span class=p>)</span>  <span class=c1># [&#39;example.com&#39;, &#39;test.org&#39;, &#39;example.com&#39;]</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=nb>print</span><span class=p>(</span><span class=n>domains_gen</span><span class=p>)</span>   <span class=c1># &lt;generator object at 0x...&gt;</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=c1># To see generator values, convert to list or iterate</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=nb>print</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>domains_gen</span><span class=p>))</span>  <span class=c1># Now you see the values</span>
</span></code></pre></div> <p>Which one would you use if you had 10 million URLs and just wanted to count unique domains?</p> <h2 id=section-3-sql-window-functions-analytics-without-self-joins>Section 3: SQL Window Functions - Analytics Without Self-Joins<a class=headerlink href=#section-3-sql-window-functions-analytics-without-self-joins title="Permanent link">&para;</a></h2> <h3 id=the-query-that-took-three-days-and-shouldve-taken-three-minutes>The Query That Took Three Days (And Should've Taken Three Minutes)<a class=headerlink href=#the-query-that-took-three-days-and-shouldve-taken-three-minutes title="Permanent link">&para;</a></h3> <p>Thursday afternoon. The VP of Product walks over to my desk. Never a good sign.</p> <p>"Hey, can you pull a quick report? For each customer, show their order history with a running total of spending and rank each order by amount. Need it for tomorrow's board meeting."</p> <p>"Sure," I said. "Quick report" sounded easy. How hard could it be?</p> <p>Six hours later, I was still at the office. My query was a monster. Multiple subqueries. Three self-joins. Temporary tables everywhere. It looked like SQL had a fight with itself and lost.</p> <p>Worse? It was <em>slow</em>. Running it on our orders table (about 2 million rows) took 45 minutes. And it kept timing out.</p> <p>I did what any desperate engineer does at 11 PM on a Thursday: I posted in the company Slack. "Anyone know how to make this faster? 🆘"</p> <p>Our senior data analyst—bless her—responded immediately: "Are you seriously not using window functions for this?"</p> <p>Window functions? I'd heard of them. Vaguely. Hadn't really bothered learning them because, you know, I could do everything with JOINs and GROUP BY. Right?</p> <p>She sent me a query. Same exact output. One-tenth the lines of code. Ran in 14 seconds.</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>SELECT</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>    </span><span class=n>amount</span><span class=p>,</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>running_total</span><span class=p>,</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>    </span><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>amount_rank</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>order_date</span><span class=p>;</span>
</span></code></pre></div> <p>I stared at it. That's it? That's the whole thing?</p> <p>Turns out, I'd spent three days trying to solve a problem that SQL had a built-in solution for. The database could calculate all those running totals and rankings in a single pass over the data. My monstrous JOIN-based approach was making it scan the table multiple times.</p> <p>Made the board meeting. Barely. Never forgot window functions again.</p> <h3 id=heres-what-window-functions-actually-do>Here's What Window Functions Actually Do<a class=headerlink href=#heres-what-window-functions-actually-do title="Permanent link">&para;</a></h3> <p>Window functions let you perform calculations across related rows without grouping them together. They're essential for analytics queries like running totals, rankings, and period-over-period comparisons.</p> <h3 id=example-e-commerce-analytics-dashboard>Example: E-Commerce Analytics Dashboard<a class=headerlink href=#example-e-commerce-analytics-dashboard title="Permanent link">&para;</a></h3> <p>Your product manager asks: "For each customer, show their order history with a running total of spending and a rank for each order by amount."</p> <p><strong>The Hard Way (Multiple Queries or Self-Joins):</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1>-- First, get orders with rankings (requires complex subquery)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=k>SELECT</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>    </span><span class=n>o1</span><span class=p>.</span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>    </span><span class=n>o1</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=n>o1</span><span class=p>.</span><span class=n>order_date</span><span class=p>,</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=n>o1</span><span class=p>.</span><span class=n>amount</span><span class=p>,</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>    </span><span class=k>COUNT</span><span class=p>(</span><span class=n>o2</span><span class=p>.</span><span class=n>order_id</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>rank_by_amount</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=n>o1</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=n>o2</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>customer_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>o2</span><span class=p>.</span><span class=n>customer_id</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>o2</span><span class=p>.</span><span class=n>amount</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>amount</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>order_date</span><span class=p>,</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>amount</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>rank_by_amount</span><span class=p>;</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=c1>-- Then you&#39;d need another query for running totals...</span>
</span></code></pre></div> <p>This query is hard to read, hard to maintain, and slow (multiple passes over the data).</p> <p><strong>The Window Function Way:</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=k>SELECT</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=n>order_id</span><span class=p>,</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>    </span><span class=n>order_date</span><span class=p>,</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span><span class=n>amount</span><span class=p>,</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>    </span><span class=c1>-- Running total of spending per customer</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>        </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>running_total</span><span class=p>,</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>    </span><span class=c1>-- Rank orders by amount within each customer</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=w>    </span><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>        </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=k>DESC</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>amount_rank</span><span class=p>,</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>    </span><span class=c1>-- Compare to previous order</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>    </span><span class=n>LAG</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=w>        </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>previous_order_amount</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>order_date</span><span class=p>;</span>
</span></code></pre></div> <p><strong>Sample Output:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>customer_id | order_id | order_date | amount | running_total | amount_rank | previous_order_amount
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>------------|----------|------------|--------|---------------|-------------|----------------------
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>1001        | 5001     | 2024-01-15 | 50.00  | 50.00         | 3           | NULL
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>1001        | 5002     | 2024-02-20 | 120.00 | 170.00        | 1           | 50.00
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>1001        | 5003     | 2024-03-10 | 75.00  | 245.00        | 2           | 120.00
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>1002        | 5004     | 2024-01-18 | 200.00 | 200.00        | 1           | NULL
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>1002        | 5005     | 2024-02-22 | 150.00 | 350.00        | 2           | 200.00
</span></code></pre></div> <h3 id=understanding-the-over-clause>Understanding the OVER Clause<a class=headerlink href=#understanding-the-over-clause title="Permanent link">&para;</a></h3> <p>The <code>OVER</code> clause defines the "window" of rows for the calculation:</p> <ul> <li><strong>PARTITION BY</strong>: Divides rows into groups (like GROUP BY, but without collapsing rows)</li> <li><strong>ORDER BY</strong>: Defines the order within each partition</li> <li><strong>Frame specification</strong> (optional): Defines exactly which rows to include (e.g., "last 7 days")</li> </ul> <div class="language-sql highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1>-- Running total for last 7 days</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=w>    </span><span class=k>ROWS</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=n>PRECEDING</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>CURRENT</span><span class=w> </span><span class=k>ROW</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=p>)</span>
</span></code></pre></div> <h3 id=common-window-functions>Common Window Functions<a class=headerlink href=#common-window-functions title="Permanent link">&para;</a></h3> <p><strong>Ranking Functions:</strong> <div class="language-sql highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1>-- No gaps in ranking (1, 2, 3, 4)</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=c1>-- Gaps when ties exist (1, 2, 2, 4)</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=c1>-- No gaps even with ties (1, 2, 2, 3)</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=n>DENSE_RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span>
</span></code></pre></div></p> <p><strong>Offset Functions:</strong> <div class="language-sql highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1>-- Previous row value</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=n>LAG</span><span class=p>(</span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span><span class=p>)</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=c1>-- Next row value</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=n>LEAD</span><span class=p>(</span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span><span class=p>)</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=c1>-- First value in partition</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=n>FIRST_VALUE</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span><span class=p>)</span>
</span></code></pre></div></p> <p><strong>Aggregate Functions as Window Functions:</strong> <div class="language-sql highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1>-- Average of partition</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=k>AVG</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span><span class=p>)</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=c1>-- Count within window</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span><span class=p>)</span>
</span></code></pre></div></p> <h3 id=why-this-matters_1>Why This Matters<a class=headerlink href=#why-this-matters_1 title="Permanent link">&para;</a></h3> <p>Window functions are crucial for: - <strong>Real-time dashboards</strong>: Calculate metrics without pre-aggregation - <strong>Time-series analysis</strong>: Period-over-period comparisons, moving averages - <strong>Ranking and percentiles</strong>: Top N per category, quartile analysis - <strong>Deduplication</strong>: Use <code>ROW_NUMBER()</code> to remove duplicates</p> <p>Most importantly, they're <strong>much faster</strong> than self-joins or multiple queries because the database engine makes a single pass over the data.</p> <h3 id=try-it_2>Try It<a class=headerlink href=#try-it_2 title="Permanent link">&para;</a></h3> <p>Given this products table:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=w>    </span><span class=n>category</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>),</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>    </span><span class=n>product_name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=w>    </span><span class=n>price</span><span class=w> </span><span class=nb>DECIMAL</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>2</span><span class=p>),</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=w>    </span><span class=n>sales_count</span><span class=w> </span><span class=nb>INT</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=p>);</span>
</span></code></pre></div> <p>Write a query that shows: 1. Each product's rank by price within its category 2. The price difference from the most expensive product in the category 3. What percentage of total category sales this product represents</p> <details> <summary>Solution</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=k>SELECT</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=w>    </span><span class=n>category</span><span class=p>,</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=w>    </span><span class=n>product_name</span><span class=p>,</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=w>    </span><span class=n>price</span><span class=p>,</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=w>    </span><span class=n>sales_count</span><span class=p>,</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=w>    </span><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>category</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>price_rank</span><span class=p>,</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=w>    </span><span class=n>FIRST_VALUE</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>category</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>price_gap</span><span class=p>,</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=w>    </span><span class=n>ROUND</span><span class=p>(</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>sales_count</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>sales_count</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>category</span><span class=p>),</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>pct_category_sales</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=k>FROM</span><span class=w> </span><span class=n>products</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>category</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span></code></pre></div> </details> <h2 id=section-4-common-table-expressions-ctes-writing-readable-sql>Section 4: Common Table Expressions (CTEs) - Writing Readable SQL<a class=headerlink href=#section-4-common-table-expressions-ctes-writing-readable-sql title="Permanent link">&para;</a></h2> <h3 id=the-query-my-future-self-couldnt-understand>The Query My Future Self Couldn't Understand<a class=headerlink href=#the-query-my-future-self-couldnt-understand title="Permanent link">&para;</a></h3> <p>Picture this: You write a complex SQL query. It works perfectly. You're a genius. You commit it and move on to the next task.</p> <p>Six months later, that query breaks. Your manager asks you to fix it. You open the file and... you have absolutely no idea what it does.</p> <p>This happened to me. Except it was only <em>three</em> weeks later, not six months. And the person who wrote it? Past me. And past me was apparently some kind of sadist who hated future me.</p> <p>Here's what I found:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>total_spent</span><span class=p>,</span><span class=w> </span><span class=n>spending_rank</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>total_spent</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>    </span><span class=k>HAVING</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>customer_total</span><span class=p>)</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>customer_total</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>            </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avg_calc</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>high_spenders</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>spending_rank</span><span class=p>;</span>
</span></code></pre></div> <p>I stared at this for twenty minutes. Subqueries inside subqueries inside subqueries. It was like SQL Inception. Every time I thought I understood one level, I'd realize there was another one nested inside.</p> <p>The worst part? The query was broken because I needed to add one simple filter. But I couldn't figure out <em>where</em> to add it without breaking the whole house of cards.</p> <p>Our database admin walked by, saw me mumbling to myself, and took pity. She rewrote it in five minutes:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=k>WITH</span><span class=w> </span><span class=n>recent_orders</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>amount</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=p>),</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=n>customer_totals</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>total_spent</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>recent_orders</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=p>),</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=n>avg_spending</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>total_spent</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avg_total</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>customer_totals</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=p>),</span>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a><span class=n>high_spenders</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>ct</span><span class=p>.</span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>ct</span><span class=p>.</span><span class=n>total_spent</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>customer_totals</span><span class=w> </span><span class=n>ct</span>
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=w>    </span><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>avg_spending</span><span class=w> </span><span class=k>avg</span>
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>ct</span><span class=p>.</span><span class=n>total_spent</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>avg</span><span class=p>.</span><span class=n>avg_total</span>
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a><span class=p>)</span>
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=k>SELECT</span><span class=w> </span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>total_spent</span><span class=p>,</span>
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=w>       </span><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>total_spent</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>spending_rank</span>
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=k>FROM</span><span class=w> </span><span class=n>high_spenders</span>
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>spending_rank</span><span class=p>;</span>
</span></code></pre></div> <p>Same exact result. But now I could <em>read</em> it. Each CTE was a named step. I could test them individually. I could understand what each piece did. And most importantly, I could add that filter in about 10 seconds because I knew exactly where it belonged.</p> <p>She said, "Write SQL like you're leaving notes for yourself. Because you are."</p> <p>That changed everything.</p> <h3 id=heres-why-ctes-are-your-friend>Here's Why CTEs Are Your Friend<a class=headerlink href=#heres-why-ctes-are-your-friend title="Permanent link">&para;</a></h3> <p>CTEs let you break complex queries into logical, named steps—like writing functions in SQL. They make your queries easier to understand, debug, and maintain.</p> <h3 id=example-multi-step-business-logic>Example: Multi-Step Business Logic<a class=headerlink href=#example-multi-step-business-logic title="Permanent link">&para;</a></h3> <p>Your analytics team needs a report showing: 1. Customers who placed orders in the last 30 days 2. Their total spending in that period 3. Only customers who spent more than the average 4. Ranked by total spending</p> <p><strong>The Nested Subquery Nightmare:</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=k>SELECT</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>    </span><span class=n>total_spent</span><span class=p>,</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>    </span><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>total_spent</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>spending_rank</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=w>        </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>total_spent</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=w>    </span><span class=k>HAVING</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>customer_total</span><span class=p>)</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>customer_total</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=w>            </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avg_calc</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>high_spenders</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>spending_rank</span><span class=p>;</span>
</span></code></pre></div> <p>This query works, but it's a mess. Try debugging it. Try explaining it to a colleague. Try modifying it six months from now.</p> <p><strong>The CTE Way:</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=k>WITH</span><span class=w> </span><span class=n>recent_orders</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=w>    </span><span class=c1>-- Step 1: Get recent orders</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=w>        </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=w>        </span><span class=n>amount</span><span class=p>,</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>        </span><span class=n>order_date</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=p>),</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=n>customer_totals</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>    </span><span class=c1>-- Step 2: Calculate total spending per customer</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=w>        </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>total_spent</span><span class=p>,</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=w>        </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>order_count</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>recent_orders</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=p>),</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=n>avg_spending</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=w>    </span><span class=c1>-- Step 3: Calculate average spending</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>total_spent</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avg_total</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>customer_totals</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=p>),</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=n>high_spenders</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=w>    </span><span class=c1>-- Step 4: Filter for above-average spenders</span>
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a><span class=w>        </span><span class=n>ct</span><span class=p>.</span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-27-28><a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a><span class=w>        </span><span class=n>ct</span><span class=p>.</span><span class=n>total_spent</span><span class=p>,</span>
</span><span id=__span-27-29><a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=w>        </span><span class=n>ct</span><span class=p>.</span><span class=n>order_count</span>
</span><span id=__span-27-30><a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>customer_totals</span><span class=w> </span><span class=n>ct</span>
</span><span id=__span-27-31><a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a><span class=w>    </span><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>avg_spending</span><span class=w> </span><span class=k>avg</span>
</span><span id=__span-27-32><a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>ct</span><span class=p>.</span><span class=n>total_spent</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>avg</span><span class=p>.</span><span class=n>avg_total</span>
</span><span id=__span-27-33><a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a><span class=p>)</span>
</span><span id=__span-27-34><a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a><span class=c1>-- Final query</span>
</span><span id=__span-27-35><a id=__codelineno-27-35 name=__codelineno-27-35 href=#__codelineno-27-35></a><span class=k>SELECT</span>
</span><span id=__span-27-36><a id=__codelineno-27-36 name=__codelineno-27-36 href=#__codelineno-27-36></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-27-37><a id=__codelineno-27-37 name=__codelineno-27-37 href=#__codelineno-27-37></a><span class=w>    </span><span class=n>total_spent</span><span class=p>,</span>
</span><span id=__span-27-38><a id=__codelineno-27-38 name=__codelineno-27-38 href=#__codelineno-27-38></a><span class=w>    </span><span class=n>order_count</span><span class=p>,</span>
</span><span id=__span-27-39><a id=__codelineno-27-39 name=__codelineno-27-39 href=#__codelineno-27-39></a><span class=w>    </span><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>total_spent</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>spending_rank</span>
</span><span id=__span-27-40><a id=__codelineno-27-40 name=__codelineno-27-40 href=#__codelineno-27-40></a><span class=k>FROM</span><span class=w> </span><span class=n>high_spenders</span>
</span><span id=__span-27-41><a id=__codelineno-27-41 name=__codelineno-27-41 href=#__codelineno-27-41></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>spending_rank</span><span class=p>;</span>
</span></code></pre></div> <p>Each CTE is a named, reusable query. You can: - Reference it multiple times (like a variable) - Read the logic step by step (like functions) - Test each step independently (copy the CTE and add a SELECT)</p> <h3 id=recursive-ctes-handling-hierarchical-data>Recursive CTEs: Handling Hierarchical Data<a class=headerlink href=#recursive-ctes-handling-hierarchical-data title="Permanent link">&para;</a></h3> <p>CTEs can be recursive, which is powerful for hierarchical data like org charts, category trees, or graph traversals.</p> <p><strong>Example: Employee Hierarchy</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w> </span><span class=n>employee_hierarchy</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=w>    </span><span class=c1>-- Base case: start with CEO (no manager)</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=w>        </span><span class=n>employee_id</span><span class=p>,</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=w>        </span><span class=n>employee_name</span><span class=p>,</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=w>        </span><span class=n>manager_id</span><span class=p>,</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>level</span><span class=p>,</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=w>        </span><span class=n>employee_name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>path</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>manager_id</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=w>    </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=w>    </span><span class=c1>-- Recursive case: find direct reports</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=n>employee_id</span><span class=p>,</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=n>employee_name</span><span class=p>,</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=n>manager_id</span><span class=p>,</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a><span class=w>        </span><span class=n>eh</span><span class=p>.</span><span class=k>level</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a><span class=w>        </span><span class=n>eh</span><span class=p>.</span><span class=n>path</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &gt; &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>employee_name</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=w> </span><span class=n>e</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>employee_hierarchy</span><span class=w> </span><span class=n>eh</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>manager_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>eh</span><span class=p>.</span><span class=n>employee_id</span>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a><span class=p>)</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a><span class=k>SELECT</span>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a><span class=w>    </span><span class=n>employee_id</span><span class=p>,</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a><span class=w>    </span><span class=n>REPEAT</span><span class=p>(</span><span class=s1>&#39;  &#39;</span><span class=p>,</span><span class=w> </span><span class=k>level</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>employee_name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>org_chart</span><span class=p>,</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a><span class=w>    </span><span class=k>level</span><span class=p>,</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a><span class=w>    </span><span class=n>path</span>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29 href=#__codelineno-28-29></a><span class=k>FROM</span><span class=w> </span><span class=n>employee_hierarchy</span>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30 href=#__codelineno-28-30></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>path</span><span class=p>;</span>
</span></code></pre></div> <p><strong>Output:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>employee_id | org_chart           | level | path
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>------------|---------------------|-------|---------------------------
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>1           | Alice (CEO)         | 1     | Alice (CEO)
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>2           |   Bob (VP)          | 2     | Alice (CEO) &gt; Bob (VP)
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>4           |     Dana (Manager)  | 3     | Alice (CEO) &gt; Bob (VP) &gt; Dana (Manager)
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a>7           |       Frank (IC)    | 4     | Alice (CEO) &gt; Bob (VP) &gt; Dana (Manager) &gt; Frank (IC)
</span></code></pre></div></p> <h3 id=why-this-matters_2>Why This Matters<a class=headerlink href=#why-this-matters_2 title="Permanent link">&para;</a></h3> <p>In data engineering, you often work with complex business logic: - Multi-stage data transformations - Incremental updates (e.g., "process only new records since last run") - Data quality checks at each step - Historical vs. current data comparisons</p> <p>CTEs help you: - <strong>Debug faster</strong>: Test each step independently - <strong>Optimize selectively</strong>: Profile which CTE is slow, optimize that one - <strong>Collaborate better</strong>: Colleagues can understand your queries - <strong>Refactor safely</strong>: Change one CTE without breaking others</p> <h3 id=try-it_3>Try It<a class=headerlink href=#try-it_3 title="Permanent link">&para;</a></h3> <p>You have these tables:</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=c1>-- users: user_id, signup_date, country</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=c1>-- orders: order_id, user_id, order_date, amount</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=c1>-- products: product_id, product_name, category</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=c1>-- order_items: order_id, product_id, quantity</span>
</span></code></pre></div> <p>Write a CTE-based query to find: 1. Users who signed up in the last 90 days 2. Made at least 3 orders 3. Purchased from at least 2 different product categories 4. Show their total spending and favorite category (by $ spent)</p> <details> <summary>Solution Framework</summary> <div class="language-sql highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=k>WITH</span><span class=w> </span><span class=n>recent_users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=w>    </span><span class=c1>-- Step 1: Get users who signed up in last 90 days</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=n>signup_date</span><span class=p>,</span><span class=w> </span><span class=n>country</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>signup_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=k>CURRENT_DATE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;90 days&#39;</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=p>),</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=n>user_orders</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=w>    </span><span class=c1>-- Step 2: Get their orders</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>ru</span><span class=p>.</span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>amount</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>recent_users</span><span class=w> </span><span class=n>ru</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=n>o</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>ru</span><span class=p>.</span><span class=n>user_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>user_id</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=p>),</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=n>user_categories</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=w>    </span><span class=c1>-- Step 3: Find categories purchased</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=w>        </span><span class=n>uo</span><span class=p>.</span><span class=n>user_id</span><span class=p>,</span>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=w>        </span><span class=n>p</span><span class=p>.</span><span class=n>category</span><span class=p>,</span>
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=n>uo</span><span class=p>.</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>category_spending</span>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>user_orders</span><span class=w> </span><span class=n>uo</span>
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>order_items</span><span class=w> </span><span class=n>oi</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>uo</span><span class=p>.</span><span class=n>order_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oi</span><span class=p>.</span><span class=n>order_id</span>
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>oi</span><span class=p>.</span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>product_id</span>
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>uo</span><span class=p>.</span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>category</span>
</span><span id=__span-31-23><a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a><span class=p>),</span>
</span><span id=__span-31-24><a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a><span class=n>qualified_users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-31-25><a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a><span class=w>    </span><span class=c1>-- Step 4: Filter for users meeting criteria</span>
</span><span id=__span-31-26><a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a><span class=w>    </span><span class=k>SELECT</span>
</span><span id=__span-31-27><a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a><span class=w>        </span><span class=n>user_id</span><span class=p>,</span>
</span><span id=__span-31-28><a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a><span class=w>        </span><span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span><span class=w> </span><span class=n>category</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>categories_purchased</span><span class=p>,</span>
</span><span id=__span-31-29><a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=n>category_spending</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>total_spending</span>
</span><span id=__span-31-30><a id=__codelineno-31-30 name=__codelineno-31-30 href=#__codelineno-31-30></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>user_categories</span>
</span><span id=__span-31-31><a id=__codelineno-31-31 name=__codelineno-31-31 href=#__codelineno-31-31></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>user_id</span>
</span><span id=__span-31-32><a id=__codelineno-31-32 name=__codelineno-31-32 href=#__codelineno-31-32></a><span class=w>    </span><span class=k>HAVING</span>
</span><span id=__span-31-33><a id=__codelineno-31-33 name=__codelineno-31-33 href=#__codelineno-31-33></a><span class=w>        </span><span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span><span class=w> </span><span class=n>category</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>2</span>
</span><span id=__span-31-34><a id=__codelineno-31-34 name=__codelineno-31-34 href=#__codelineno-31-34></a><span class=w>        </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>user_orders</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>user_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>user_categories</span><span class=p>.</span><span class=n>user_id</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>3</span>
</span><span id=__span-31-35><a id=__codelineno-31-35 name=__codelineno-31-35 href=#__codelineno-31-35></a><span class=p>)</span>
</span><span id=__span-31-36><a id=__codelineno-31-36 name=__codelineno-31-36 href=#__codelineno-31-36></a><span class=c1>-- Continue from here...</span>
</span><span id=__span-31-37><a id=__codelineno-31-37 name=__codelineno-31-37 href=#__codelineno-31-37></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>qualified_users</span><span class=p>;</span>
</span></code></pre></div> </details> <h2 id=scars-ive-earned-so-you-dont-have-to>Scars I've Earned (So You Don't Have To)<a class=headerlink href=#scars-ive-earned-so-you-dont-have-to title="Permanent link">&para;</a></h2> <h3 id=1-using-list-comprehensions-when-you-need-generators>1. Using List Comprehensions When You Need Generators<a class=headerlink href=#1-using-list-comprehensions-when-you-need-generators title="Permanent link">&para;</a></h3> <p><strong>The Mistake:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=c1># Loading 1 billion records into memory</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=n>data</span> <span class=o>=</span> <span class=p>[</span><span class=n>row</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>read_database</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM huge_table&#39;</span><span class=p>)]</span>
</span></code></pre></div></p> <p><strong>The Fix:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=c1># Processing one row at a time</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=n>row</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>read_database</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM huge_table&#39;</span><span class=p>))</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a>    <span class=n>process</span><span class=p>(</span><span class=n>row</span><span class=p>)</span>
</span></code></pre></div></p> <p><strong>When to worry:</strong> Any time your data source is larger than available RAM, or when you're processing data exactly once.</p> <p><strong>What it cost me:</strong> $47,000 in AWS bills and a very awkward conversation with my CTO.</p> <h3 id=2-forgetting-partition-by-in-window-functions>2. Forgetting PARTITION BY in Window Functions<a class=headerlink href=#2-forgetting-partition-by-in-window-functions title="Permanent link">&para;</a></h3> <p><strong>The Mistake:</strong> <div class="language-sql highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=c1>-- This calculates running total across ALL customers</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=k>SELECT</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>running_total</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=p>;</span>
</span></code></pre></div></p> <p><strong>The Fix:</strong> <div class="language-sql highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=c1>-- Running total per customer</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=k>SELECT</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=w>    </span><span class=n>customer_id</span><span class=p>,</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>        </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>customer_id</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>order_date</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>running_total</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=p>;</span>
</span></code></pre></div></p> <p><strong>What it cost me:</strong> Three days debugging why customer totals were wildly wrong, one very confused VP of Product, and the nickname "Overflow" (because my totals kept overflowing into other customers).</p> <h3 id=3-over-nesting-ctes>3. Over-Nesting CTEs<a class=headerlink href=#3-over-nesting-ctes title="Permanent link">&para;</a></h3> <p><strong>The Mistake:</strong> <div class="language-sql highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=k>WITH</span><span class=w> </span><span class=n>step1</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(...),</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=w>     </span><span class=n>step2</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>step1</span><span class=p>),</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=w>     </span><span class=n>step3</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>step2</span><span class=p>),</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=w>     </span><span class=n>step4</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>step3</span><span class=p>)</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=w>     </span><span class=c1>-- 10 more steps...</span>
</span></code></pre></div></p> <p><strong>The Fix:</strong> If you have more than 5-6 CTEs, consider breaking the query into multiple steps or creating a temporary table for intermediate results. CTEs are great for readability, but too many can hurt performance and become hard to follow.</p> <p><strong>What it cost me:</strong> A query that took 2 hours to run when it should've taken 5 minutes. Turns out, the query optimizer gave up and just did what I said instead of optimizing it.</p> <h3 id=4-not-understanding-generator-exhaustion>4. Not Understanding Generator Exhaustion<a class=headerlink href=#4-not-understanding-generator-exhaustion title="Permanent link">&para;</a></h3> <p><strong>The Mistake:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>))</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=nb>print</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>  <span class=c1># 499500</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=nb>print</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>  <span class=c1># 0 (generator is exhausted!)</span>
</span></code></pre></div></p> <p><strong>The Fix:</strong> Either recreate the generator, or use a list if you need multiple iterations: <div class="language-python highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1># Option 1: Recreate</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>))</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=nb>print</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>))</span>  <span class=c1># Recreate</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=nb>print</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=c1># Option 2: Use list if data is small</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=n>data</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>))</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=nb>print</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=nb>print</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>  <span class=c1># Works fine</span>
</span></code></pre></div></p> <p><strong>What it cost me:</strong> Two hours debugging why my second calculation always returned zero. Felt like an idiot when I figured it out.</p> <h2 id=reflection-questions>Reflection Questions<a class=headerlink href=#reflection-questions title="Permanent link">&para;</a></h2> <ol> <li><strong>When would you NOT use a generator?</strong></li> </ol> <p>Think about these scenarios: - You need to access the length of the data - You need to iterate over the data multiple times - You need random access (indexing) - The dataset is small and you want faster access</p> <p>What's the trade-off you're making in each case?</p> <ol> <li><strong>Your query with window functions is slow. What would you check first?</strong></li> </ol> <p>Hint: Window functions require sorting. What does sorting require? What if your PARTITION BY column isn't indexed?</p> <ol> <li><strong>You have a 10-step data transformation pipeline. When should you use CTEs vs. temporary tables vs. intermediate files?</strong></li> </ol> <p>Consider: - How long does each step take? - Do you need to inspect intermediate results? - Are you running this once or repeatedly? - What if step 7 fails—do you want to recompute steps 1-6?</p> <ol> <li><strong>A colleague writes a query with five self-joins to calculate ranks and running totals. You suggest window functions. They say, "But my way works." How do you convince them?</strong></li> </ol> <p>This is about more than performance—it's about maintainability, readability, and what happens when the data grows 10x next year.</p> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <ul> <li> <p><strong>Generators enable streaming data processing</strong>, allowing you to work with datasets larger than memory by processing one item at a time. Use generator expressions <code>(x for x in ...)</code> when you only need to iterate once.</p> </li> <li> <p><strong>List comprehensions are for reusable data</strong> that fits in memory. Use <code>[x for x in ...]</code> when you need to iterate multiple times, check length, or use indexing.</p> </li> <li> <p><strong>Window functions eliminate self-joins</strong> and enable advanced analytics like running totals, rankings, and period-over-period comparisons in a single query pass.</p> </li> <li> <p><strong>CTEs break complex queries into logical steps</strong>, making SQL more readable, debuggable, and maintainable. Use them to structure multi-step business logic.</p> </li> <li> <p><strong>Performance matters at scale</strong>: Code that works on 1,000 rows may fail at 1,000,000. Always consider memory usage, query execution plans, and whether your solution will scale.</p> </li> <li> <p><strong>Learn from mistakes quickly</strong>: The best engineers aren't the ones who never mess up—they're the ones who mess up, learn fast, and share the lessons so others don't have to repeat them.</p> </li> </ul> <h2 id=next-steps>Next Steps<a class=headerlink href=#next-steps title="Permanent link">&para;</a></h2> <p>Now that you have Python and SQL foundations, it's time to think about collaboration and deployment. In Chapter 2, we'll explore Git workflows for team development and Docker for creating reproducible, portable environments. You'll learn how to:</p> <ul> <li>Manage merge conflicts when multiple engineers work on the same pipeline</li> <li>Use branching strategies for safe feature development</li> <li>Containerize your data pipelines for consistent execution across environments</li> <li>Orchestrate multi-container systems with Docker Compose</li> </ul> <p>The patterns you learned here—streaming processing, query optimization, readable code structure—will carry forward. But now we need to ensure your carefully crafted pipelines work the same way on your laptop, your colleague's machine, and in production.</p> <p>And maybe, just maybe, you'll avoid deploying to production on a Thursday afternoon.</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2026 Data Engineering Bootcamp </div> </div> <div class=md-social> <a href=https://github.com/yourusername/data-engineering-course target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/yourprofile target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>